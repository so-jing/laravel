define(function(require,exports,module){function renderMoreBtn(a){return['<div class="more-reply">点击展开后面<span>',a,"</span>条回复</div>"].join("")}function renderReply(a,c){function v(c){return a==c?"<em>提问者</em> ":""}function h(a){return""==a.to_username?"":[" <span>回复</span> ",v(a.to_uid),'<a class="to-user" href="/u/',a.to_uid,'/bbs">',a.to_username,"</a>"].join("")}var $="";OP_CONFIG.userInfo&&OP_CONFIG.userInfo.uid!=c.from_uid&&($='<a href="javascript:void(0)"  data-uid="'+c.from_uid+'" data-type="3" data-id="'+c.id+'" class="reply-del js-tip-off">举报</a>');var g="";OP_CONFIG.userInfo&&3==OP_CONFIG.userInfo.usertype&&(g='<a href="javascript:void(0)"  data-type="3" data-id="'+c.id+'" class="reply-del js-del">删除</a>');var y="",w="";2==c.from_usertype&&(y+='<i class="type_teach" style="margin-left: 6px;" title="慕课网讲师"></i>'),2==c.to_usertype&&(w+='<i class="type_teach" style="margin-left: 6px;" title="慕课网讲师"></i>'),c.from_userachieves&&"undefined"!=typeof c.from_userachieves.wenda_top_n_of_week&&(y+='<span class="answer-member" style="margin-left: 6px; vertical-align: -2px;" title="回答达人"></span>'),c.to_userachieves&&"undefined"!=typeof c.to_userachieves.wenda_top_n_of_week&&(w+='<span class="answer-member" style="margin-left: 6px; vertical-align: -2px;" title="回答达人"></span>'),c.user_achieves&&"undefined"!=typeof c.user_achieves.wenda_top_n_of_week&&(y+='<span class="answer-member" style="margin-left: 6px; vertical-align: -2px;" title="回答达人"></span>');var j=['<li class="clearfix">','<div class="user-pic">','<a href="/u/',c.from_uid,'/bbs" target="_blank">','<img src="',c.from_pic||"//img.mukewang.com/images/unknow-160.png",'" alt="',c.from_username,'"/>',"</a>","</div>",'<div class="user-info clearfix">',v(c.from_uid),'<a class="from-user" href="/u/',c.from_uid,'/bbs">',c.from_username,"</a>",y,h(c),w,'<span class="r floor">#',c.floor,"</span>","</div>",'<div class="reply-content">',c.description,"</div>",'<div class="reply-btn l" data-uid="',c.from_uid,'" data-username="',c.from_username,'">回复</div>',$,g,'<span class="time r">',c.create_time,"</span>","</li>"];return j.join("")}function renderReplyList(a,c){for(var v=[],i=0,h=c.length;h>i;i++)v.push(renderReply(a,c[i]));return v.join("")}var verifyCode=require("../common/verify-code.js");require("/static/lib/layer/1.6.0/layer.min.js"),require("/static/lib/layer/1.6.0/skin/layer.css"),function(){$("#main .aimgPreview img").each(function(){$(this).attr("data-src",$(this).attr("alt"))}),setTimeout(function(){moco.imagePreview.init(["#main .aimgPreview"])},300)}(),$("body").on("click",".js-tip-off",function(){var a=$(this),c=a.data("type"),v=a.data("uid"),h=a.data("id");return isLogin?($(".js-tipoff-typebox").find(".tipoff-loading").show(),$(".js-tipoff-block").show(),$(".js-tipoff-box").show(),$.ajax({url:"/service/reporttypes",type:"POST",dataType:"json",xhrFields:{withCredentials:!0},crossDomain:!0,success:function(a){if(0==a.status){var c=a.data,v=$(".js-tipoff-typebox"),h="";$.each(c,function(i){h+='<div class="item l">                                    <i class="l icon-checkbox_o js-tipoff-select" data-type="'+c[i].id+'"></i>                                    <p class="l">'+c[i].name+"</p>                                </div>"}),v.find(".tipoff-loading").hide(),v.append(h)}else $.prompt(a.msg,{icon:"error"}),AjaxTipoff=0},error:function(){$.prompt("举报接口异常！",{icon:"error"}),AjaxTipoff=0},complete:function(){AjaxTipoff=0}}),void $(".js-tipoff-submit").attr({"data-type":c,"data-uid":v,"data-id":h})):void $("#js-signin-btn").click()}),$(".js-tipoff-typebox").on("click",".js-tipoff-select",function(){var a=$(this),c=a.data("type"),v=$(".tipoff-type-box").find(".js-tipoff-select"),h=function(a){a.hasClass("on")?(a.removeClass("on icon-checkbox"),$(".js-tipoff-submit").attr("data-tipofftype","")):($.each(v,function(i,a){$(a).removeClass("icon-checkbox").removeClass("on")}),a.addClass("icon-checkbox on"),$(".js-tipoff-submit").attr("data-tipofftype",c))};h(a)});var hideTipoff=function(){$(".js-tipoff-block").hide(),$(".js-tipoff-box").hide();var a='<div class="tipoff-loading">                        <div class="bounce1"></div>                        <div class="bounce2"></div>                        <div class="bounce3"></div>                    </div>';$(".js-tipoff-typebox").html(a),$(".js-tipoff-desc").val(""),$(".tipoff-text").find(".js-tipoff-text").html("0").css("color","#93999F");var c=$(".tipoff-type-box").find(".js-tipoff-select");$.each(c,function(i,a){$(a).removeClass("icon-checkbox").removeClass("on")}),$(".js-tipoff-submit").attr({"data-type":"","data-uid":"","data-id":"","data-tipofftype":""})};$(".js-tipoff-close").on("click",function(){hideTipoff()}),$(".js-tipoff-desc").keyup(function(){var a=$(this),c=$(".tipoff-text").find(".js-tipoff-text"),v=$.trim(a.val().replace(/[\r\n]/g,"")).length;v>150?c.html(v).css("color","#f01414"):c.html(v).css("color","#93999f")});var AjaxTipoff=0;$(".js-tipoff-submit").on("click",function(){var a=$(this),c=window.location.href,v=a.attr("data-uid"),h=a.attr("data-type"),g=a.attr("data-id"),y=a.attr("data-tipofftype"),w=$.trim($(".js-tipoff-desc").val().replace(/[\r\n]/g,""));if(AjaxTipoff)return void $.prompt("操作频繁，请稍后",{icon:"error"});if("undefined"==typeof y||""==y)return void $.prompt("请选择举报类型！",{icon:"error"});if(w.length>150)return void $.prompt("举报理由字数超限，请重新输入!",{icon:"error"});var j={report_type:y,page_url:c,reported_uid:v,reported_type:h,reported_type_id:g};0!=w.length&&(j.report_desc=w),AjaxTipoff=1,$.ajax({url:"/service/report",data:j,type:"POST",dataType:"json",xhrFields:{withCredentials:!0},crossDomain:!0,success:function(a){0==a.status?($.prompt(a.msg,{icon:"success"}),AjaxTipoff=0,hideTipoff()):-110==a.status?($.prompt(a.msg,{icon:"error"}),hideTipoff(),AjaxTipoff=0):-11==a.status?($.prompt(a.msg,{icon:"error"}),window.location.reload()):($.prompt(a.msg,{icon:"error"}),AjaxTipoff=0)},error:function(){$.prompt("接口异常！",{icon:"error"}),AjaxTipoff=0},complete:function(){AjaxTipoff=0}})}),$(function(){function isInView(a){var c=$(window).height(),v=$(window).scrollTop(),h=a.height(),g=a.offset().top;return c+v>h+g?!0:!1}function openTagPop(a){"followtag"==a&&$("#tag-pop h3 span").text("关注我喜欢或专注的猿问分类"),"allclass"==a&&($("#tag-pop h3 span").text("全部分类"),$("#tag-pop .save-btn").remove(),$("#tag-pop .tag-list").find(".active").removeClass("active")),$("#tag-pop").attr("data-type",a).fadeIn(200)}$(".share-box .show-btn").on("mouseenter",function(){var a=$(this),c=a.parent();c.hasClass("hover")||c.addClass("hover")}).on("mouseleave",function(e){e.stopPropagation();var a=$(this),c=a.parent();c.hasClass("hover")&&c.removeClass("hover")}),$(".share-box .share-box-con").on("mouseenter",function(){var a=$(this),c=a.parent();c.hasClass("hover")||c.addClass("hover")}).on("mouseleave",function(){var a=$(this),c=a.parent();c.hasClass("hover")&&c.removeClass("hover")}).on("click",function(){var a=$(this),c=a.parent();c.hasClass("hover")&&c.removeClass("hover")});var scrollHandle=function(){var a={},c=[];return function(v,h,g){return a.start=function(){for(var i=0,a=c.length;a>i;i++)if(c[i]==v)return;c.push(v);var y=h.parent(),w=y.width(),j=y.offset().left;$(window).on("scroll.answer"+v,function(){var a=h.offset().top,c=y.offset().top,v=a-c;if(isInView(y))h.hasClass("fixed")&&(h.removeClass("fixed"),h.css("left",0).css("width","100%"));else if(g>=v)h.hasClass("fixed")&&(h.removeClass("fixed"),h.css("left",0).css("width","100%"));else if($(window).scrollTop()+$(window).height()-y.offset().top<g)h.hasClass("fixed")&&(h.removeClass("fixed"),h.css("left",0).css("width","100%"));else{if(h.hasClass("fixed"))return;h.addClass("fixed"),h.css("left",j+"px").css("width",w+"px")}})},a.end=function(){for(var i=0,a=c.length;a>i;i++)if(c[i]==v){c.splice(i,1);break}{var g=h.parent();g.width(),g.offset().left}g.hasClass("extend")&&g.removeClass("extend"),h.hasClass("fixed")&&(h.removeClass("fixed"),h.css("left",0).css("width","100%")),$(window).off("scroll.answer"+v)},a}}(),toUserInfo={},canSubmit=!0;with($(".ques-answer").on("succ","textarea",function(){$(this).parent().next(".err-tip").text("")}).on("fail","textarea",function(e,a){$(this).parent().next(".err-tip").text(a)}).on("click",".see-more",function(){var a=$(this).parents(".answer-con"),c=a.find(".ctrl-bar"),v=a.attr("data-answer-id"),h=a.find(".shrink"),g=c.offset().top-a.offset().top,y=0;if(!a.hasClass("extend")){a.addClass("extend"),h.fadeIn(0),y=c.offset().top-a.offset().top;var w=scrollHandle(v,c,g,y);w.start()}}).on("click",".shrink",function(){var a=$(this),c=a.parents(".answer-con"),v=a.parent(),h=c.attr("data-answer-id"),g=scrollHandle(h,v);g.end(),a.hide(0),c.removeClass("extend")}).on("click",".reply-btn",function(){toUserInfo.uid=$(this).attr("data-uid"),toUserInfo.uname=$(this).attr("data-username");var a=$(this).parents(".reply-con"),c=a.find("textarea");c.focus().val("回复 "+toUserInfo.uname+"：").attr("touser","回复 "+toUserInfo.uname+"：")}).on("click",".do-reply-btn",function(){var a=$(this);if(!isLogin)return void $("#js-signin-btn").click();if(!canSubmit)return void $.prompt("操作频繁，请稍后");var c=$(this).parents(".reply-con"),v=c.prev(".answer-con").find(".reply"),h=v.attr("data-replynum"),g=c.find(".reply-list"),y=c.find("textarea"),w=$(this).attr("data-answer-id"),j=y.val(),b=$(this).attr("data-ques-uid"),C={},_=y.attr("touser");if(-1!=j.indexOf(_)?(j=j.replace(_,""),C.to_uid=toUserInfo.uid):C.to_uid="",j=$.trim(j),j.length<3)return void y.trigger("fail","字数不够，最少3个字");if(j.length>1200)return void y.trigger("fail","超过字数上限，最多1200个字");if(C.reply_id=w,C.description=j,0!=c.find(".js-verify-refresh").length){var k=$.trim(verifyCode.getResult(c.find(".verify-code")));if(0==k.length)return void c.find(".verify-code").trigger("fail","请输入验证码");C.verify_code=k}canSubmit=!1,a.text("回复中.."),$.ajax({url:"/wenda/wdsavereplycomment",data:C,type:"POST",dataType:"json",success:function(a){if(0==a.result){a.data.id=a.data.reply_id;var w=renderReply(b,a.data),j=g.find("li").length;3!=j?(g.append(w),v.hasClass("js-hasData")||v.addClass("js-hasData")):0==c.find(".more-reply").length?g.after(renderMoreBtn(1)):c.find(".more-reply span").text(parseInt(c.find(".more-reply span").text())+1),v.attr("data-replynum",parseInt(h)+1),y.val("").removeAttr("touser").trigger("succ")}else{if(-1==a.result&&1==a.data)return void verifyCode.renderVerifyCodeBlock(c.find(".verify-code"),"/wenda/getverifycode");if(-103002==a.result)return void c.find(".verify-code").trigger("fail","验证码错误");$.prompt(a.msg,{timeout:2e3,icon:"error"})}c.find(".err-tip").text(""),c.find(".verify-code").html("")},complete:function(){canSubmit=!0,a.text("回复")}})}).on("click",".agree-with",function(){if(!isLogin)return void $("#js-signin-btn").click();var a=$(this).attr("data-ques-id"),c=$(this).attr("data-answer-id"),v={},h=!0,g=$(this);v.ques_id=a,v.reply_id=c,g.hasClass("disabled")||(g.addClass("disabled"),$(this).hasClass("active")?(v.op="unsupport",h=!1):(v.op="support",h=!0),$.ajax({url:"/wenda/wdsupport",type:"post",dataType:"json",data:v,success:function(a){if(0==a.result){var c=g.siblings(".oppose");if(h){g.addClass("active");var v=g.find("em");if(0==v.length)g.append("<em>1</em>");else{var $=parseInt(v.text());$+=1,v.text($)}"undefined"!=typeof g.find("b")&&g.find("b").text("已赞同"),c.hasClass("active")&&c.removeClass("active").find("em").text("反对")}else{g.removeClass("active");var v=g.find("em"),$=parseInt(v.text());$=0>$-1?0:$-1,0==$?v.remove():v.text($),"undefined"!=typeof g.find("b")&&g.find("b").text("赞同")}}},complete:function(){g.removeClass("disabled")}}))}).on("click",".oppose",function(){if(!isLogin)return void $("#js-signin-btn").click();var a=$(this).attr("data-ques-id"),c=$(this).attr("data-answer-id"),v={},h=!0,g=$(this);v.ques_id=a,v.reply_id=c,g.hasClass("disabled")||(g.addClass("disabled"),$(this).hasClass("active")?(v.op="unoppose",h=!0):(v.op="oppose",h=!1),$.ajax({url:"/wenda/wdsupport",type:"post",dataType:"json",data:v,success:function(a){if(0==a.result)if(h)g.removeClass("active").find("em").text("反对");else{g.addClass("active").find("em").text("已反对");var c=g.siblings(".agree-with");if(c.hasClass("active")){var v=parseInt(c.find("em").text());v=0>v-1?0:v-1,0==v?c.removeClass("active").find("em").remove():c.removeClass("active").find("em").text(v),"undefined"!=typeof g.find("b")&&c.find("b").text("赞同")}}},complete:function(){g.removeClass("disabled")}}))}).on("click",".reply",function(){var a=$(this),c=a.attr("data-reply-id"),v=parseInt(a.find("em").text()),h=a.parents(".answer-con").next(".reply-con"),g=a.attr("data-ques-uid"),y=h.find(".reply-list"),w=h.find(".release-reply-con");if(a.hasClass("js-show"))return h.hide(0),void a.html('<em class="js-num">'+a.attr("data-replynum")+"</em>个回复").removeClass("js-show");if($(".reply-con").hide(0),$(".js-show").html('<em class="js-num">'+$(".js-show").attr("data-replynum")+"</em>个回复").removeClass("js-show"),a.addClass("js-show"),a.text("收起回复"),h.fadeIn(200),a.hasClass("js-hasData")){var j=0;return j=0!=y.find("li").length?y.offset().top:w.offset().top,void $("html,body").animate({scrollTop:j+"px"},200)}if(0!=v)$.ajax({url:"/wenda/getcomments",type:"get",dataType:"json",data:{reply_id:c},success:function(c){if("0"==c.result){var h=renderReplyList(g,c.data);y.append(h);var $=v-3;if($>0){var w=renderMoreBtn($);y.after(w)}a.addClass("js-hasData")}},complete:function(){var a=0;0!=y.find("li").length&&(a=y.offset().top)}});else{var j=0;j=w.offset().top}}).on("click",".more-reply",function(){var a=$(this),c=$(this).parents(".reply-con").prev(".answer-con").find(".reply"),v=c.attr("data-reply-id"),h=c.attr("data-ques-uid"),g=a.siblings(".reply-list");$.ajax({url:"/wenda/getcomments",type:"get",dataType:"json",data:{reply_id:v,page:2},success:function(c){if("0"==c.result){var v=renderReplyList(h,c.data);g.append(v),a.remove()}}})}).on("click",".share",function(){$(this).siblings(".bdsharebuttonbox").fadeIn(200)}).on("click",".follow",function(e){if(e.preventDefault(),!isLogin)return void $("#js-signin-btn").click();var a=$(this),c=a.attr("data-ques-id"),v=a.find(".heart").length,h=a.find("i"),g={};g.bbsId=c,g.act=0==v?"del":"add",$.ajax({url:"/wenda/wendafollow",type:"get",dataType:"json",data:g,success:function(a){0==a.result&&(0==v?(h.attr("class","heart"),h.html("关注")):(h.attr("class","heart-revert"),h.html("取消关注")))}})}).on("click",".login-btn",function(){$("#js-signin-btn").click()}).on("click",".register-btn",function(){$("#js-signup-btn").click()}).on("click",".js-lgn",function(){return isLogin?void 0:void $("#js-signin-btn").click()}).on("click",".js-rgr",function(){return isLogin?void 0:void $("#js-signup-btn").click()}),$(".js-quiz").on("click",function(){isLogin?window.location.href="/wenda/save":$("#js-signin-btn").click()}),$("#tag-pop").on("click",".js-close",function(){$("#tag-pop").hide(0);var a=$("#tag-pop").attr("data-type");"allclass"!=a&&isLogin&&window.location.reload()}).on("click","li",function(){var a=$("#tag-pop").attr("data-type");if("followtag"==a)$(this).hasClass("active")?$(this).removeClass("active"):$(this).addClass("active");else{var c=$(this).attr("data-tag-id");window.open("/wenda/"+c)}}).on("click",".save-btn",function(){var a=$(this).siblings(".tag-list"),c=[],v=a.find(".active");$.each(v,function(i,n){var a=$(n).attr("data-tag-id");c.push(a)}),$.ajax({url:"/wenda/customtag",type:"post",dataType:"json",data:{tagIds:c.join(",")},success:function(a){0==a.result&&window.location.reload()}})}),0!=$(".my-follow-class").length&&$(".my-follow-class").on("click",".js-open",function(){openTagPop("followtag")}).on("click",".follow-immediately",function(){openTagPop("followtag")}),$(".recommend-class").on("click",".all-cls",function(){openTagPop("allclass")}).on("click",".follow",function(){if(!isLogin)return void $("#js-signin-btn").click();var a=$(this).attr("data-tag-id"),c=$(this);$(this).hasClass("disabled")||($(this).addClass("disabled"),$.ajax($(this).hasClass("active")?{url:"/wenda/canceltag",data:{tagIds:a},type:"post",dataType:"json",success:function(a){0==a.result&&(c.removeClass("active"),"wdcategory"==OP_CONFIG.page?c.text("关注"):window.location.reload())},complete:function(){c.removeClass("disabled")}}:{url:"/wenda/followtag",data:{tagIds:a},type:"post",dataType:"json",success:function(a){0==a.result&&(c.addClass("active"),"wdcategory"==OP_CONFIG.page?c.text("取消关注"):window.location.reload())},complete:function(){c.removeClass("disabled")}}))}),document)0[(getElementsByTagName("head")[0]||body).appendChild(createElement("script")).src="/static/lib/baiduShare/api/js/share.js?cdnversion="+~(-new Date/36e5)];var shareEles=$(".bdsharebuttonbox a");shareEles.on("click",function(e){e.preventDefault()})})});
define(function(require,exports,module){require("/static/lib/backbone/backbone-1.0.0.min.js");var a=require("./tpl.js"),c=Backbone.View.extend({initialize:function(c){this.tpl=a;var h=this;this.timer=null,this.hasPass=c.hasPass,moco.validateCallback.checkPhone=function(a){h.blurToCheckPhone(a)}},events:{"click .tpl-settingPhone .js-getCode":"clickTogetCode","click .tpl-settingPhone .js-submit":"clickToSubmit"},resendCode:function(){clearInterval(this.timer);var a=60,c=this.$el.find(".js-timer"),h=this;this.timer=setInterval(function(){1>a?(clearInterval(h.timer),c.html("重新获取"),c.addClass("js-getCode"),c.css("cursor","pointer")):(c.text(a+"s"),c.html('<span style="color:#B4B8BB">获取验证码['+a+"]</span>")),a--},1e3)},clickTogetCode:function(){var a=this.$el.find(".js-phoneNumber").val(),c=this;$.ajax({url:"/passport/user/checkphonecode",dataType:"json",data:{phone:a,noverify:1},success:function(a){10001==a.status?($(".js-timer").removeClass("js-getCode").css("cursor","default"),c.resendCode()):c.$el.find(".js-gerror").html(a.msg)},error:function(){$(".tpl-settingPhone .js-submit").text("保存"),c.$el.find(".js-gerror").html("系统出错，请稍后重试！")},complete:function(){}})},timerForColse:function(){},blurToCheckPhone:function(a){var c=a;moco.validateCallback.rel=!1,$.ajax({url:"/passport/user/checkphone",type:"post",data:{phone:c},dataType:"json",success:function(a){10001==a.status?moco.validateCallback.rel=!0:(moco.validateCallback.errorHint=a.msg,$(".js-phoneNumber").parents(".moco-form-group").find(".moco-control-tip").html(a.msg))},error:function(){moco.validateCallback.errorHint="网络错误"}})},clickToSubmit:function(){if(W.validate(this.$el.find(".tpl-settingPhone"))){var a=this;$(".tpl-settingPhone .js-submit").text("正在保存...");var c=this.$el.find(".js-phoneNumber").val(),h=this.$el.find(".js-phoneCode").val(),v={};if(v.phone=c,v.code=h,v.noverify=1,!this.hasPass){var b=this.$el.find(".js-pwd").val(),j=this.$el.find(".js-surPwd").val();v.password=b,v.password_confirm=j}$.ajax({url:"/passport/user/bindphone",dataType:"json",data:v,success:function(c){if(10001==c.status){var i=5;$(".js-modal-close").click(),$.dialog('<div class="icon-tick-revert s-right"></div>                                    <div class="finshBox">                                     <p class="success-hint">恭喜你！手机号绑定成功</p>                                    <button class="moco-btn moco-btn-blue js-modal-close js-timer-5">完成[5]</button>                                </div>                                ',{modal:!0,title:"  ",width:488});var h=setInterval(function(){i>0?$(".js-timer-5").text("完成["+i--+"]"):(clearInterval(h),window.location.reload())},1e3)}else a.$el.find(".js-gerror").html(c.msg)},error:function(){util.layerError("系统错误！"),$this.text("立即验证")},complete:function(){$(".tpl-settingPhone .js-submit").text("确定")}})}},render:function(){$.dialog(this.tpl,{modal:!0,title:"绑定手机",width:488,height:"auto"}),this.hasPass&&this.$el.find(".js-hassPassHide").remove()},renderFinish:function(){$(".js-modal-close").click(),$.dialog(' <div class="icon-tick-revert s-right"></div><p class="success-hint">恭喜你绑定成功</p><button class="moco-btn moco-btn-blue "></button>',{modal:!0,title:"绑定手机",width:488}),this.timerForColse()}});module.exports=c});
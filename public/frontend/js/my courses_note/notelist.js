define(function(require){require("./u_common.js"),require("lib/juicer/juicer.min.js"),require("lib/pagination/jquery.pagination.js");var a=require("/static/component/base/util/picViewer"),c=function(a){return"string"==typeof a?a.replace(/[^\x00-\xff]/g,"01").length:0},h=function(s){return s=""+s,s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")},g=function(a){return a.indexOf("http")>=0?a.slice(a.indexOf(":")+1,a.length):a},_=function(a,c,h){var g=new RegExp(c,"g"),$=a.match(g);return h?$?$.length:0:($?$.length:0)*c.length},v=function(a,c){var h=["<i  class='highlight'>","</i>"],f=function(a,c,g,$){if($&&0>=g)return $;var v=$||"";$=a.slice(0,c);var j=_($,h[0]),y=_($,h[1]);return g=c-j-y,f(a.slice(c,a.length),c-g,g,v+$)},a=f(a,c,0),g=a.lastIndexOf("<i"),$=a.lastIndexOf("</i>");g>$&&(a=a.slice(0,g));var v=_(a,h[0],!0),j=_(a,h[1],!0);return v>j&&(a+="</i>"),a},j={fns:{},on:function(a,c,h){"undefined"==typeof h&&(h=c,c=this),this.fns[a]||(this.fns[a]=[]),h.ctx=c,this.fns[a].push(h)},emit:function(a,c){for(var h=this.fns[a],i=0;i<h.length;i++)h[i].call(h[i].ctx,c)}},y=OP_CONFIG.userInfo.uid,w=[],k={init:function(){this.searchTimer=null,this.bindEvent()},value:"",search:function(a){var c="";c="empty"==a?"":$.trim(a.value);var h={word:$.trim(c)};this.value=h.word,""==this.value?$(".p2").show():$(".p2").hide(),C.get(h,"search")},nodata:function(){return C.nodata("search")},handle:function(a){return C.handle(a,"search")},render:function(a){var c=this,h="",g=$("#searchlist");h=a.hits.length<=0?this.nodata():this.handle(a),g.html(h),j.emit("search/total/change",{value:c.value,total:a.total})},bindEvent:function(){var a=this;$(".search-btn").on("click",function(){$(".note-search-input");a.search("empty"),C.toggerpage()}),$(".js-input-close").on("click",function(){$("#searchlist").html(""),$(".g1").html(""),$(".g2").html(""),$(".p2").hide(),$(".js-input-text").val(""),C.toggerpage()}),j.on("search/total/change",function(a){$(".g1").html(a.value),$(".g2").html(a.total)}),j.on("render/search",function(c){a.render(c)}),$(".js-input-text").on("keyup",function(){var c=this;clearTimeout(a.searchTimer),a.searchTimer=setTimeout(function(){a.search(c)},500)}),$(document).on("click",".js-all-note",function(){a.search("empty")})}},b={init:function(){this.bindEvent()},count:{imooc:{min:3,max:1e3},sz:{min:1,max:300},path:{min:3,max:2e3}},editShow:function(e,a){var c=$("#edit-tpl").html(),a=a||this,h=b.getOptions(a);container=h.$item.find(".item-content"),data={content:h.$input.attr("data-content"),id:h.id,conut:h.count},h.$item.addClass("editing"),container.append(juicer(c,data)),b.updateInputLen(null,h.$item.find(".js-note-textarea")[0])},editHide:function(){var a=$(this).parents(".js-item");a.removeClass("editing"),a.find(".js-editarea").remove()},editAllHide:function(){$("js-item").removeClass("editing").find(".js-editarea").remove()},updateInputLen:function(e,a){var a=a||this,h=$(a).parents(".js-editarea"),g=h.find(".js-note-limit"),_=g.attr("data-maxlength"),v=c(a.value);v>_?g.addClass("c_red"):g.removeClass("c_red"),g.text(v)},getOptions:function(a){var c=$(a).parents(".js-item"),h=c.find(".js-input"),g=h.attr("data-type");return{$item:c,$input:h,type:g,id:h.attr("data-noteid"),count:b.count[g]}},del:function(e,a){var a=a||this,c=b.getOptions(a);$.confirm("笔记删除将无法恢复，您确定要删除这条笔记吗？",{callback:function(){b.post[c.type].del(c.id,function(){b.delsuccess(c)})}})},delsuccess:function(a){w.push(a.id),C.reload()},save:function(e,a){var a=a||this,c=b.getOptions(a),h=$.trim(c.$item.find(".js-note-textarea").val()),g=c.$item.find(".error-tip");return g.html(""),""==h||h.length<c.count.min?(g.html("笔记最少"+c.count.min+"个字符！"),!1):c.$item.find(".c_red")[0]?(g.html("笔记不能超过"+c.count.max+"个字符！"),!1):void b.post[c.type].save(c.id,h,function(){b.sevesuccess(c,h)})},sevesuccess:function(a,c){var h=c;c.length>180&&(h=c.slice(0,180)+"..."),a.$item.find(".item-p1").html(h),a.$item.find(".item-p2").html(c),a.$item.find(".js-input").attr("data-content",c),a.$item.find(".js-cancel").trigger("click")},post:{imooc:{del:function(a,c){$.ajax({url:"/u/"+y+"/note/"+a,type:"DELETE",dataType:"json",success:function(a){0==a.result?($.prompt("操作成功",{icon:"success"}),c&&c()):$.prompt(a.msg,{icon:"error"})}})},save:function(a,c,h){$.post("/u/"+y+"/note/"+a,{content:c},function(a){0==a.result?($.prompt("操作成功",{icon:"success"}),h&&h()):$.prompt(a.msg,{icon:"error"})},"json")}},sz:{del:function(a,c){$.post("/u/"+y+"/szdelnote",{note_id:a},function(a){0==a.result?($.prompt("操作成功",{icon:"success"}),c&&c()):$.prompt(a.msg,{icon:"error"})},"json")},save:function(a,c,h){var g={note_id:a,content:c};$.post("/u/"+y+"/szsavenote",g,function(a){0==a.result?($.prompt("操作成功",{icon:"success"}),h&&h()):$.prompt(a.msg,{icon:"error"})},"json")}},path:{del:function(a,c){$.post("/u/"+y+"/plans/delnote",{nid:a},function(a){0==a.result?($.prompt("操作成功",{icon:"success"}),c&&c()):$.prompt(a.msg,{icon:"error"})},"json")},save:function(a,c,h){var g={nid:a,content:c};$.post("/u/"+y+"/plans/editnote",g,function(a){0==a.result?($.prompt("操作成功",{icon:"success"}),h&&h()):$.prompt(a.msg,{icon:"error"})},"json")}}},lookimg:function(e,c){var c=c||this,h=$(c).attr("data-pic");h&&a.create(h)},lookcodeFlag:!1,lookcode:function(e,a){if(a=a||this,b.lookcodeFlag)return!1;b.lookcodeFlag=!0;var c=$(a).attr("data-id");return c?(require.async("../course/common/view_code",function(a){a.init("/course/viewnotecode",c,{})}),void setTimeout(function(){b.lookcodeFlag=!1},1e3)):(b.lookcodeFlag=!1,!1)},bindEvent:function(){$(document).on("input",".js-note-textarea",b.updateInputLen),$(document).on("click",".js-edit",b.editShow),$(document).on("click",".js-cancel",b.editHide),$(document).on("click",".js-delete",b.del),$(document).on("click",".js-save",b.save),$(document).on("click",".js-lookimg",b.lookimg),$(document).on("click",".js-lookcode",b.lookcode),$(document).on("click",".js-more",function(){var a=$(this).parents(".js-item"),c=$(this).attr("data-type");"close"==c?(a.find(".item-p1").hide(),a.find(".item-p2").show()):(a.find(".item-p2").hide(),a.find(".item-p1").show())})}},C={init:function(){b.init(),this.bindEvent(),this.get(),k.init()},API:{getNote:"//search.imooc.com/api/note/search"},toggerpage:function(){var a=$(".note-search-input");a.hasClass("show")?($("#container").show(),$("#searchContainer").hide(),a.removeClass("show")):($("#container").hide(),$("#searchContainer").show(),a.addClass("show"),$(".js-input-text").trigger("focus"))},pageSize:20,page:1,get:function(a,c){var h=this;a=a||{},a.uid=y,a.length=h.pageSize,!a.year&&$(".js-year-btn")[0]&&"search"!=c&&(a.year=$(".js-year-btn").eq("0").attr("data-year")),$.ajax({type:"post",async:!1,url:h.API.getNote,data:a,dataType:"json",success:function(g){"success"==g.message&&(h.page=a.page||1,"search"==c?j.emit("render/search",g.data.hits):j.emit("render",g.data.hits))},error:function(){$.alert("请求数据异常")}})},render:function(a){var c=this,h="",g=$("#notelist");h=a.hits.length<=0?this.nodata():this.handle(a),c.page>1&&$(window).scrollTop(280),j.emit("total/change",a.total),g.html(h),$("#pagination").html(""),a.total>c.pageSize&&$("#pagination").pagination(a.total,{prev_text:"上一页",next_text:"下一页",items_per_page:c.pageSize,num_display_entries:3,num_edge_entries:1,current_page:c.page-1,callback:function(a){j.emit("page/change",a)}})},getdomain:function(a){return"tbl_course_note"==a._type?{type:"imooc",path_href:!1,course_href:"//www.imooc.com/learn/"+a._source.course_id,media_url:"//www.imooc.com/video/"+a._source.media_id}:"tbl_shizhan_note"==a._type?{type:"sz",path_href:!1,course_href:"http://coding.imooc.com/learn/list/"+a._source.course_id+".html",media_url:"http://coding.imooc.com/lesson/"+a._source.course_id+".html#mid="+a._source.media_id}:"tbl_zhiye_note"==a._type?{type:"path",path_href:"http://class.imooc.com/sc/"+a._source.plan_id+"/learn",course_href:"http://class.imooc.com/course/"+a._source.course_id,media_url:"http://class.imooc.com/lesson/"+a._source.course_id+"#mid="+a._source.media_id}:void 0},handle:function(a,t){var c,_=this,j=$("#axis-item-tpl").html(),y="";return $.each(a.hits,function(a,$){if(w.indexOf($._source.id)>-1)return!0;var k=$._source.content;t&&"search"==t?$.highlight?($._source.content=$.highlight.content[0],$._content=v($.highlight.content[0],180)):$._content=v($._source.content,180):$._content=k.slice(0,180),k.length>180?($.lengthout=1,$._content=$._content+"..."):$.lengthout=0,$._source.lang>0&&($.langid=$._source.src_note_id&&$._source.src_note_id>0?$._source.src_note_id:$._source.id),$._content=h($._content),$._source.content2=$._source.content,$._source.content=h($._source.content),$._source.picture_url=g($._source.picture_url),c=_.getdomain($),$._type=c.type,$.path_href=c.path_href,$.course_href=c.course_href,$.media_url=c.media_url,y+=juicer(j,$)}),y},errordata:function(){return this.nodata("error")},nodata:function(a){var c=$(".js-domain.active").attr("data-type"),h=$("#nodata-tpl").html(),g={};return"search"==a?juicer(h,{text:"未找到匹配的笔记",search_href_name:"查看全部笔记"}):"error"==a?juicer(h,{text:"请求数据异常",search_href_name:"重试"}):(0==c?g={name:"",href_name:"课程",href:"//www.imooc.com/course/list"}:1==c?g={name:"课程",href_name:"课程",href:"//www.imooc.com/course/list"}:2==c?g={name:"实战",href_name:"实战",href:"http://coding.imooc.com"}:3==c&&(g={name:"职业路径",href_name:"职业路径",href:"http://class.imooc.com"}),juicer(h,g))},reload:function(a){var c={},h=$(".js-year-btn.active").attr("data-year");c.type=$(".js-domain.active").attr("data-type"),h&&(c.year=h),a&&(c.page=a),this.get(c)},bindEvent:function(){var a=this;j.on("render",function(c){a.render(c)}),j.on("page/change",function(c){c="NaN"==Number(c)?1:Number(c),c+=1,a.reload(c)}),j.on("total/change",function(a){$(".js-total").html(a)}),$(document).on("click",".js-year-btn",function(){if($(this).hasClass("active"))return!1;var c={},h=$(this).attr("data-year");h&&(c.year=h),c.type=$(".js-domain.active").attr("data-type"),$(this).siblings(".js-year-btn").removeClass("active"),$(this).addClass("active"),a.get(c)}),$(document).on("click",".js-domain",function(){if($(this).hasClass("active"))return!1;var c={},h=$(".js-year-btn.active").attr("data-year");h&&(c.year=h),c.type=$(this).attr("data-type"),$(this).siblings(".js-domain").removeClass("active"),$(this).addClass("active"),a.get(c)})}},z=function(){C.init()};z()});